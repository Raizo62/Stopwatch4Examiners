<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stopwatch4Examiners</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            transition: background-color 0.5s ease;
        }
        .container {
            text-align: center;
            margin-bottom: 20px;
        }
        .counter {
            font-size: 48px;
            margin-bottom: 20px;
        }
        .cadre {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        button:focus {
            outline: none;
        }
        input {
            width: 60px;
            padding: 5px;
            margin: 5px;
            font-size: 16px;
            text-align: center;
        }
        @keyframes flashOrange {
            0%, 100% { background-color: #f0f0f0; }
            50% { background-color: orange; }
        }
        @keyframes flashRed {
            0%, 100% { background-color: #f0f0f0; }
            50% { background-color: red; }
        }
        .flashing-orange {
            animation: flashOrange 1s infinite;
        }
        .flashing-red {
            animation: flashRed 1s infinite;
        }
        .config-label {
            display: block;
            margin-bottom: 10px;
        }
        .sub-config {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            background-color: #fafafa;
        }
        .sub-config h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="soutenance" class="cadre">
            <h3>Soutenance</h3>
            <div id="soutenanceCompteur" class="container">
                <div class="counter" id="soutenanceChrono">00:00:00</div>
                <button id="soutenanceBoutonStart">Start</button>
                <button id="soutenanceBoutonPause" disabled>Pause</button>
                <button id="soutenanceBoutonQuestions" disabled>Questions</button>
            </div>
        </div>
        <div id="questions" class="cadre">
            <h3>Questions</h3>
            <div id="questionsCompteur" class="container">
                <div class="counter" id="questionsChrono">00:00:00</div>
                <button id="questionsBoutonPause" disabled>Pause</button>
                <button id="questionsBoutonTerminer"disabled>Terminer</button>
            </div>
        </div>
        <div id="config" class="cadre">
            <h3>Configurations</h3>
            <div class="sub-config" id="soutenanceConfig">
                <h4>Soutenance</h4>
                <label class="config-label">Durée (min) : 
                <input type="number" id="soutenanceDuree" value="15" min="1">
                </label>
                <label class="config-label">Marge (min) : 
                <input type="number" id="soutenanceMargeAutorisee" value="2" min="0">
                </label>
            </div>
            <div class="sub-config" id="questionsConfig">
                <h4>Questions</h4>
                <label class="config-label">Durée (min) : 
                <input type="number" id="questionDuree" value="10" min="0">
                </label>
                <label class="config-label">Marge (min) : 
                <input type="number" id="questionMargeAutorisee" value="2" min="0">
                </label>
            </div>
        </div>
    </div>
    <script>
      let questionsIntervalId;    // Variable pour suivre l'intervalle du chronomètre des questions
      let isPausedQuestions = false;
      let counterQuestions = 0;
      let wakeLock = null;

      async function requestWakeLock() {
          try {
              wakeLock = await navigator.wakeLock.request('screen');
              wakeLock.addEventListener('release', () => {
                  console.log('Wake Lock was released');
              });
          } catch (err) {
              console.error(`${err.name}, ${err.message}`);
          }
      }

      async function releaseWakeLock() {
          if (wakeLock !== null) {
              await wakeLock.release();
              wakeLock = null;
              console.log('Screen wake lock released');
          }
      }

      function unlockButton(buttonSoutenanceStart, buttonSoutenancePause, buttonSoutenanceQuestions,   buttonQuestionsPause, buttonQuestionsTerminer) {
          document.getElementById("soutenanceBoutonStart").disabled = ! buttonSoutenanceStart;
          document.getElementById("soutenanceBoutonPause").disabled = ! buttonSoutenancePause;
          document.getElementById("soutenanceBoutonQuestions").disabled = ! buttonSoutenanceQuestions;
          document.getElementById("questionsBoutonPause").disabled = ! buttonQuestionsPause;
          document.getElementById("questionsBoutonTerminer").disabled = ! buttonQuestionsTerminer;
      }

      function formatTime(totalSeconds) {
          const hours = Math.floor(totalSeconds / 3600);
          const minutes = Math.floor((totalSeconds % 3600) / 60);
          const seconds = totalSeconds % 60;
          return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      }

      function updateChrono(displayId, seconds) {
          document.getElementById(displayId).textContent = formatTime(seconds);
      }

      function createCounter(counterId, counterDisplayId, startBtnId, pauseBtnId, stopBtnId, orangeThresholdId, redThresholdId, onStopCallback) {
          let timeBegin = 0;
          let timeAlreadyUP = 0;
          let intervalId;
          let isPaused = false;
          let hasStarted = false;

          function startCounter() {
              intervalId = setInterval(() => {
                  if (!isPaused) {
                      const timeEnd = performance.now();
                      const counter = timeAlreadyUP + Math.floor((timeEnd-timeBegin)/1000);

                      // Affichage formaté
                      updateChrono(counterDisplayId, counter);

                      // Récupération des seuils personnalisés
                      const orangeThreshold = document.getElementById(orangeThresholdId).value * 60;
                      const redThreshold = orangeThreshold + document.getElementById(redThresholdId).value * 60;

                      // Vérification du seuil orange
                      if (counter === orangeThreshold) {
                          document.body.classList.remove("flashing-red");
                          document.body.classList.add("flashing-orange");
                      }

                      // Vérification du seuil rouge
                      if (counter === redThreshold) {
                          document.body.classList.remove("flashing-orange");
                          document.body.classList.add("flashing-red");
                      }
                  }
              }, 1000);
          }

          document.getElementById(startBtnId).addEventListener('click', () => {
              if (!hasStarted) {
                  hasStarted = true;
                  timeBegin = performance.now();
                  startCounter();
                  document.getElementById(startBtnId).textContent = "Reinit";
                  unlockButton(true, true, true,   false, false);
                  requestWakeLock(); // Demander le verrouillage de l'écran
              } else {
                  // Réinitialiser le chrono
                  timeBegin = performance.now();
                  timeAlreadyUP = 0;
                  document.getElementById(counterDisplayId).textContent = "00:00:00";
                  document.body.classList.remove("flashing-orange");
                  document.body.classList.remove("flashing-red");
                  unlockButton(true, true, true,   false, false);

                  // Arrêter et réinitialiser le chrono des questions
                  if (questionsIntervalId) {
                      clearInterval(questionsIntervalId);
                      document.getElementById("questionsChrono").textContent = "00:00:00";
                      document.body.classList.remove("flashing-orange");
                      document.body.classList.remove("flashing-red");
                  }

                  // Réinitialiser le chronomètre et le redémarrer
                  if (intervalId) clearInterval(intervalId);
                  startCounter();
              }
          });

          document.getElementById(pauseBtnId).addEventListener('click', () => {
              if( ! isPaused )
              { // The counter will be stopped
                const timeEnd = performance.now();
                timeAlreadyUP = timeAlreadyUP + Math.floor((timeEnd-timeBegin)/1000);
                isPaused = true;
                document.getElementById(pauseBtnId).textContent = "Continuer";
                unlockButton(true, true, true,   false, false);
              }
              else
              { // The counter will be restarted
                timeBegin = performance.now();
                isPaused = false;
                document.getElementById(pauseBtnId).textContent = "Pause";
                unlockButton(true, true, true,   false, false);
              }
          });

          document.getElementById(stopBtnId).addEventListener('click', () => {
              clearInterval(intervalId);
              document.body.classList.remove("flashing-orange");
              document.body.classList.remove("flashing-red");

              if (onStopCallback) {
                  onStopCallback();
              }
              // Ne pas appeler releaseWakeLock ici
          });
      }

      function soutenanceStartCompteur() {
          createCounter("soutenanceCompteur", "soutenanceChrono", "soutenanceBoutonStart", "soutenanceBoutonPause", "soutenanceBoutonQuestions", "soutenanceDuree", "soutenanceMargeAutorisee", () => {
              // Quand on termine la soutenance, on démarre le compteur des questions
              // Le compteur des questions est déjà visible
              unlockButton(false, false, false,   true, true);
              startQuestionsCounter(); // Démarrer le chronomètre des questions ici
          });
      }

      function startQuestionsCounter() {
          let timeBegin = performance.now();
          let timeAlreadyUP = 0;
          isPausedQuestions = false;    // Initialiser l'état de pause des questions

          questionsIntervalId = setInterval(() => {
              if (!isPausedQuestions) {
                  const timeEnd = performance.now();
                  const counterQuestions=timeAlreadyUP + Math.floor((timeEnd-timeBegin)/1000);

                  updateChrono("questionsChrono", counterQuestions);

                  const orangeThreshold = document.getElementById("questionDuree").value * 60;
                  const redThreshold = orangeThreshold + document.getElementById("questionMargeAutorisee").value * 60;

                  if (counterQuestions === orangeThreshold) {
                      document.body.classList.remove("flashing-red");
                      document.body.classList.add("flashing-orange");
                  }

                  if (counterQuestions === redThreshold) {
                      document.body.classList.remove("flashing-orange");
                      document.body.classList.add("flashing-red");
                  }
              }
          }, 1000);

          document.getElementById("questionsBoutonPause").addEventListener('click', () => {
              if( ! isPausedQuestions )
              { // The counter will be stopped
                  const timeEnd = performance.now();
                  timeAlreadyUP = timeAlreadyUP + Math.floor((timeEnd-timeBegin)/1000);
                  isPausedQuestions = true;
                  document.getElementById("questionsBoutonPause").textContent = "Continuer";
                  unlockButton(false, false, false,   true, true);
              }
              else
              { // The counter will be restarted
                  timeBegin = performance.now();
                  isPausedQuestions = false;
                  document.getElementById("questionsBoutonPause").textContent = "Pause";
                  unlockButton(false, false, false,   true, true);
              }
          });

          document.getElementById("questionsBoutonTerminer").addEventListener('click', () => {
              clearInterval(questionsIntervalId);
              document.body.classList.remove("flashing-orange");
              document.body.classList.remove("flashing-red");
              // Enlever la ligne suivante pour ne pas réinitialiser le chronomètre
              // document.getElementById("questionsChrono").textContent = "00:00:00";
              releaseWakeLock(); // Libérer le verrouillage de l'écran
              unlockButton(true, false, false,   false, false);
          });
      }

      // Initialisation du chronomètre de soutenance dès le chargement de la page
      soutenanceStartCompteur();

    </script>
</body>
</html>
